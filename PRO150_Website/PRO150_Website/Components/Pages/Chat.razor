@page "/chat"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@rendermode InteractiveServer
@using PRO150_Website.Components.Models
@inject HttpClient Http
<PageTitle>Chat</PageTitle>

<div style="text-align: end">
    <button type="button" 
        class="btn btn-primary"
        @onclick="NewChat">
        Start New Chat
    </button>
</div>
<div style="height: 90vh; background-color: lightslategray">
    @foreach (string c in Chats.activeChat)
    {
        <div>@c</div>
        <br />
    }

</div>
<div style="height: 50px; text-align: end;">
    <EditForm FormName="Message" Model="message" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <div>
            <InputText style="width: 70%" id="message" @bind-Value="message.message" />
        </div>
    </EditForm>
</div>

@code {
    private Message message = new Message();

    async private void OnSubmit() {
        Chats.activeChat.Add(message.message);
        await SendRequest(new ChatMessage{role = "user", content = message.message});
        message.message = "";
        StateHasChanged();
    }

    private async Task SendRequest(ChatMessage msg)
    {
        var request = new ChatRequest
        {
            //local LM studio model
            model = "openai/chatgpt-oss-120b",
            stream = true,
            messages = new()
            {
                new ChatMessage { role = "system", content = "You answer only in rhymes." },
                msg
            }
        };

        var httpRequest = new HttpRequestMessage(
            HttpMethod.Post,
            "http://localhost:1234/v1/chat/completions"
        );

        httpRequest.Content = JsonContent.Create(request);

        var response = await Http.SendAsync(
            httpRequest,
            HttpCompletionOption.ResponseHeadersRead
        );

        using var stream = await response.Content.ReadAsStreamAsync();
        using var reader = new StreamReader(stream);
        
        Chats.activeChat.Add(""); // INTENTIONALLY BLANK, DO NOT REMOVE.
        while (!reader.EndOfStream)
        {
            var line = await reader.ReadLineAsync();
            if (string.IsNullOrWhiteSpace(line)) continue;
            if (line.StartsWith("data: "))
            {
                line = line.Substring(6);
            }

            if (line == "[DONE]")
            {
                break;
            }

            try
            {
                using var doc = JsonDocument.Parse(line);
                var root = doc.RootElement;

                if (root.TryGetProperty("choices", out var choices))
                {
                    var firstChoice = choices[0];

                    if (firstChoice.TryGetProperty("delta", out var delta))
                    {
                        if (delta.TryGetProperty("content", out var content))
                        {
                            if (content.GetString() != null)
                            {
                                if (Chats.activeChat.Count > 0)
                                {
                                    Chats.activeChat[^1] += content.GetString();
                                }
                                StateHasChanged();
                            }
                        }
                    }
                }
            }
            catch (JsonException)
            {
                continue;
            }
        }
        //Chats.activeChat.Add(botMessage);
    }
    
    private void NewChat() { Chats.NewChat(); }
}
