@page "/chat"
@using System.ComponentModel.DataAnnotations
@using System.Text.Json
@rendermode InteractiveServer
@using PRO150_Website.Components.Models
@inject HttpClient Http
<PageTitle>Chat</PageTitle>

<div style="text-align: end">
    <button type="button" 
        class="btn btn-primary"
        @onclick="NewChat">
        Start New Chat
    </button>
</div>
<div style="height: 90vh; background-color: lightslategray">
    @foreach (string c in Chats.activeChat)
    {
        <div>@c</div>
        <br />
    }

</div>
<div style="height: 50px; text-align: end;">
    <EditForm FormName="Message" Model="message" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <div>
            <InputText style="width: 70%" id="message" @bind-Value="message.message" />
        </div>
    </EditForm>
</div>

@code {
    private Message message = new Message();
    private bool canSubmit = true;

    async private void OnSubmit()
    {
        if (canSubmit)
        {
            canSubmit = false;
            Chats.activeChat.Add("User: " + message.message);
            await SendRequest(new MessageBuilder().BuildMsg(Chats.activeChat));
            message.message = "";
            StateHasChanged();
            canSubmit = true;
        }
    }

    private async Task SendRequest(ChatMessage msg, string model = "openai/chatgpt-oss-120b")
    {
        var request = new ChatRequest
        {
            model = model,
            stream = true,
            messages = new()
            {
                new SystemPromptBuilder().BuildMsg("`Bot:` is you, `User:` is the user. Respond to the most recent `User:` query."),
                msg
            }
        };

        var httpRequest = new HttpRequestMessage(
            HttpMethod.Post,
            "http://localhost:1234/v1/chat/completions"
        );

        httpRequest.Content = JsonContent.Create(request);

        try
        {
            var response = await Http.SendAsync(
                httpRequest,
                HttpCompletionOption.ResponseHeadersRead
            );

            if (!response.IsSuccessStatusCode)
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                Chats.activeChat.Add($"Request failed ({(int)response.StatusCode}): {errorBody}");
                StateHasChanged();
                return;
            }

            using var stream = await response.Content.ReadAsStreamAsync();
            using var reader = new StreamReader(stream);

            Chats.activeChat.Add("Bot: "); // INTENTIONALLY BLANK, DO NOT REMOVE.
            while (!reader.EndOfStream)
            {
                var line = await reader.ReadLineAsync();
                if (string.IsNullOrWhiteSpace(line)) continue;
                if (line.StartsWith("data: "))
                {
                    line = line.Substring(6);
                }

                if (line == "[DONE]")
                {
                    break;
                }

                try
                {
                    using var doc = JsonDocument.Parse(line);
                    var root = doc.RootElement;

                    if (root.TryGetProperty("choices", out var choices))
                    {
                        var firstChoice = choices[0];

                        if (firstChoice.TryGetProperty("delta", out var delta))
                        {
                            if (delta.TryGetProperty("content", out var content))
                            {
                                if (content.GetString() != null)
                                {
                                    if (Chats.activeChat.Count > 0)
                                    {
                                        Chats.activeChat[^1] += content.GetString();
                                    }
                                    StateHasChanged();
                                }
                            }
                        }
                    }
                }
                catch (JsonException)
                {
                    continue;
                }
            }
        }
        catch (HttpRequestException ex)
        {
            Chats.activeChat.Add($"[ERR] Connection failed: {ex.Message}");
            StateHasChanged();
        }
    }

    private void NewChat() { Chats.NewChat(); }
}